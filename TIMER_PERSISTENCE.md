# æŒä¹…åŒ–è®¡æ—¶ç³»ç»Ÿå®ç°æ–‡æ¡£

## ğŸ¯ é—®é¢˜æè¿°
- **åŸé—®é¢˜**: é¡µé¢åˆ·æ–°ä¼šå¯¼è‡´15åˆ†é’Ÿå€’è®¡æ—¶é‡ç½®
- **å®éªŒè¦æ±‚**: è·¨4ä¸ªé˜¶æ®µï¼ˆTask 1, 2, 3, 4ï¼‰çš„æŒä¹…åŒ–è®¡æ—¶

## âœ… å·²å®ç°çš„åŠŸèƒ½

### 1. åç«¯è®¡æ—¶å™¨ç®¡ç†

#### æ•°æ®ç»“æ„
åœ¨æ¯ä¸ªä»»åŠ¡çš„ `task_set` ä¸­æ·»åŠ  `timer` å­—æ®µï¼š

```json
{
  "task_id": 1,
  "timer": {
    "started_at": "2026-01-24T10:00:00",
    "end_time": "2026-01-24T10:15:00",
    "duration": 900,
    "is_expired": false
  },
  "conversation": [...],
  "submitted": false
}
```

#### æ–°å¢APIç«¯ç‚¹

1. **POST /api/users/me/tasks/{task_id}/start**
   - å¯åŠ¨ä»»åŠ¡è®¡æ—¶å™¨
   - å¦‚æœå·²å¯åŠ¨ï¼Œè¿”å›ç°æœ‰è®¡æ—¶å™¨ä¿¡æ¯
   - é¦–æ¬¡å¯åŠ¨æ—¶åˆå§‹åŒ– `started_at` å’Œ `end_time`

2. **GET /api/users/me/tasks/{task_id}/timer**
   - è·å–ä»»åŠ¡è®¡æ—¶å™¨çŠ¶æ€
   - æ£€æŸ¥æ˜¯å¦è¶…æ—¶
   - è¿”å›å‰©ä½™æ—¶é—´ä¿¡æ¯

#### åç«¯æ ¡éªŒ
- åœ¨ `/api/ai/response` å’Œ `/api/ai/response/stream` ä¸­æ·»åŠ è¶…æ—¶æ£€æŸ¥
- è¶…æ—¶åè¿”å› 403 é”™è¯¯ï¼Œæ‹’ç»å¯¹è¯è¯·æ±‚
- é˜²æ­¢ç”¨æˆ·ä¿®æ”¹å‰ç«¯ä»£ç ç»•è¿‡è®¡æ—¶é™åˆ¶

### 2. å‰ç«¯æŒä¹…åŒ–é€»è¾‘

#### è®¡æ—¶å™¨å¯åŠ¨æµç¨‹
```javascript
async startConversationTimer() {
  1. è°ƒç”¨åç«¯ API å¯åŠ¨è®¡æ—¶å™¨
  2. ä» end_time è®¡ç®—å‰©ä½™æ—¶é—´
  3. å¦‚æœå·²è¶…æ—¶ â†’ é”å®šè¾“å…¥æ¡†
  4. å¦åˆ™ â†’ å¯åŠ¨å€’è®¡æ—¶
}
```

#### é¡µé¢åˆ·æ–°æ¢å¤
```javascript
async restoreTimerIfNeeded() {
  1. æ£€æŸ¥ä»»åŠ¡æ˜¯å¦å·²å¼€å§‹ï¼ˆæœ‰èŠå¤©è®°å½•ï¼‰
  2. è°ƒç”¨ GET /api/users/me/tasks/{task_id}/timer
  3. è®¡ç®—å‰©ä½™æ—¶é—´
  4. æ¢å¤å€’è®¡æ—¶æ˜¾ç¤º
}
```

#### è¶…æ—¶é”å®š
```javascript
lockConversation() {
  - ç¦ç”¨è¾“å…¥æ¡†
  - ç¦ç”¨å‘é€æŒ‰é’®
  - æç¤º"å¯¹è¯æ—¶é—´å·²ç»“æŸ"
}
```

### 3. é˜¶æ®µé”å®šæœºåˆ¶

æ¯ä¸ªä»»åŠ¡ç‹¬ç«‹è®¡æ—¶ï¼š
- **Task 1**: ç¬¬1æ¬¡å¯¹è¯ï¼Œç‹¬ç«‹15åˆ†é’Ÿ
- **Task 2**: ç¬¬2æ¬¡å¯¹è¯ï¼Œç‹¬ç«‹15åˆ†é’Ÿ
- **Task 3**: ç¬¬3æ¬¡å¯¹è¯ï¼Œç‹¬ç«‹15åˆ†é’Ÿ
- **Task 4**: ç¬¬4æ¬¡å¯¹è¯ï¼Œç‹¬ç«‹15åˆ†é’Ÿ

ç”¨æˆ·æ•°æ®ç»“æ„ï¼š
```json
{
  "user_id": "user123",
  "experiment_phase": 2,
  "task_set": [
    {
      "task_id": 1,
      "submitted": true,
      "timer": {
        "started_at": "2026-01-24T10:00:00",
        "end_time": "2026-01-24T10:15:00",
        "is_expired": true
      }
    },
    {
      "task_id": 2,
      "submitted": false,
      "timer": {
        "started_at": "2026-01-27T14:30:00",
        "end_time": "2026-01-27T14:45:00",
        "is_expired": false
      }
    }
  ]
}
```

## ğŸ§ª æµ‹è¯•æ­¥éª¤

### æµ‹è¯•1: é¦–æ¬¡å¯åŠ¨è®¡æ—¶å™¨
1. ç™»å½•è´¦å·
2. è¿›å…¥ä»»åŠ¡1
3. ç‚¹å‡»"å¼€å§‹ä»»åŠ¡"
4. âœ… è®¡æ—¶å™¨å¼€å§‹å€’è®¡æ—¶ï¼ˆ15:00 â†’ 14:59...ï¼‰
5. æ£€æŸ¥åç«¯æ•°æ®æ–‡ä»¶ï¼Œç¡®è®¤ `timer` å­—æ®µå·²ä¿å­˜

### æµ‹è¯•2: åˆ·æ–°é¡µé¢æ¢å¤è®¡æ—¶
1. å¯åŠ¨ä»»åŠ¡åï¼Œç­‰å¾…å€’è®¡æ—¶åˆ° 12:30 å·¦å³
2. **åˆ·æ–°é¡µé¢ (F5)**
3. âœ… è®¡æ—¶å™¨åº”è¯¥æ˜¾ç¤º ~12:30ï¼Œè€Œä¸æ˜¯é‡ç½®åˆ° 15:00
4. ç»§ç»­å€’è®¡æ—¶æ­£å¸¸

### æµ‹è¯•3: å…³é—­æµè§ˆå™¨åæ¢å¤
1. å¯åŠ¨ä»»åŠ¡åï¼Œç­‰å¾…åˆ° 10:00 å·¦å³
2. **å®Œå…¨å…³é—­æµè§ˆå™¨**
3. é‡æ–°æ‰“å¼€æµè§ˆå™¨ï¼Œç™»å½•
4. âœ… è®¡æ—¶å™¨æ˜¾ç¤º ~10:00ï¼Œç»§ç»­å€’è®¡æ—¶

### æµ‹è¯•4: è¶…æ—¶é”å®š
1. å¯åŠ¨ä»»åŠ¡
2. ç­‰å¾…15åˆ†é’Ÿï¼ˆæˆ–ä¿®æ”¹åç«¯ duration ä¸º 60 ç§’å¿«é€Ÿæµ‹è¯•ï¼‰
3. âœ… å€’è®¡æ—¶åˆ° 00:00 æ—¶ï¼š
   - è¾“å…¥æ¡†è¢«ç¦ç”¨
   - æ˜¾ç¤º"å¯¹è¯æ—¶é—´å·²ç»“æŸ"
   - æ— æ³•å‘é€æ¶ˆæ¯

### æµ‹è¯•5: åç«¯æ ¡éªŒé˜²ä½œå¼Š
1. å¯åŠ¨ä»»åŠ¡å¹¶ç­‰å¾…è¶…æ—¶
2. æ‰“å¼€å¼€å‘è€…å·¥å…·ï¼Œå°è¯•ä¿®æ”¹å‰ç«¯è§£é”è¾“å…¥æ¡†
3. å°è¯•å‘é€æ¶ˆæ¯
4. âœ… åç«¯åº”è¿”å› 403 é”™è¯¯ï¼Œæ‹’ç»è¯·æ±‚

### æµ‹è¯•6: å¤šé˜¶æ®µç‹¬ç«‹è®¡æ—¶
1. å®Œæˆ Task 1ï¼ˆæäº¤é—®å·ï¼‰
2. è¿›å…¥ Task 2
3. ç‚¹å‡»"å¼€å§‹ä»»åŠ¡"
4. âœ… Task 2 çš„è®¡æ—¶å™¨ä» 15:00 å¼€å§‹ï¼Œä¸å— Task 1 å½±å“

## ğŸ”§ å¿«é€Ÿæµ‹è¯•é…ç½®

å¦‚æœæƒ³å¿«é€Ÿæµ‹è¯•è¶…æ—¶åŠŸèƒ½ï¼Œå¯ä»¥ä¿®æ”¹åç«¯ä»£ç ï¼š

```python
# app.py - start_task_timer() å‡½æ•°
duration = 60  # æ”¹ä¸º60ç§’ï¼Œå¿«é€Ÿæµ‹è¯•
```

æˆ–è€…ä¿®æ”¹å‰ç«¯æ˜¾ç¤ºï¼š
```javascript
// index.html - startConversationTimer()
const remainingSeconds = Math.max(0, Math.floor((endTime - now) / 1000));
console.log('å‰©ä½™æ—¶é—´:', remainingSeconds, 'ç§’');
```

## ğŸ“Š æ•°æ®æµç¨‹å›¾

```
ç”¨æˆ·ç‚¹å‡»"å¼€å§‹ä»»åŠ¡"
    â†“
å‰ç«¯è°ƒç”¨ POST /api/users/me/tasks/1/start
    â†“
åç«¯æ£€æŸ¥ task_set[0].timer
    â†“
â”œâ”€ å·²æœ‰ timer â†’ è¿”å›ç°æœ‰æ•°æ®
â””â”€ æ—  timer â†’ åˆ›å»ºæ–° timer
    â†“
    started_at = now
    end_time = now + 15åˆ†é’Ÿ
    ä¿å­˜åˆ° data/users/{user_id}.json
    â†“
å‰ç«¯æ”¶åˆ° end_time
    â†“
è®¡ç®—å‰©ä½™ç§’æ•° = end_time - now
    â†“
å¯åŠ¨å€’è®¡æ—¶æ˜¾ç¤º
    â†“
æ¯ç§’æ›´æ–° UI
    â†“
å‰©ä½™æ—¶é—´ = 0 â†’ é”å®šè¾“å…¥æ¡†
```

## ğŸ” è°ƒè¯•å»ºè®®

### æŸ¥çœ‹åç«¯æ•°æ®
```bash
# æŸ¥çœ‹ç”¨æˆ·æ•°æ®æ–‡ä»¶
cat data/users/admin.json | python -m json.tool

# æŸ¥æ‰¾ timer å­—æ®µ
cat data/users/admin.json | grep -A 5 "timer"
```

### æ§åˆ¶å°æ—¥å¿—
å‰ç«¯ä¼šè¾“å‡ºä»¥ä¸‹æ—¥å¿—ï¼š
- `[DEBUG] æ¢å¤è®¡æ—¶å™¨ï¼Œå‰©ä½™æ—¶é—´: 720 ç§’`
- `[DEBUG] ä»»åŠ¡å·²è¶…æ—¶`
- `å¯åŠ¨è®¡æ—¶å™¨å¤±è´¥: ...`

åç«¯ä¼šè¾“å‡ºï¼š
- `AIæµå¼å“åº”é”™è¯¯: ...`ï¼ˆå¦‚æœè¶…æ—¶ï¼‰

### æ£€æŸ¥ LocalStorage
æ‰“å¼€æµè§ˆå™¨å¼€å‘è€…å·¥å…· (F12)ï¼š
```javascript
// Application â†’ Local Storage
localStorage.getItem('session_token')
localStorage.getItem('user_data')
```

## ğŸš¨ å·²çŸ¥é™åˆ¶

### 1. æœåŠ¡å™¨æ—¶é—´ä¾èµ–
- è®¡æ—¶ä¾èµ–æœåŠ¡å™¨æ—¶é—´
- å¦‚æœç”¨æˆ·ä¿®æ”¹æœ¬åœ°æ—¶é—´ï¼Œä»¥æœåŠ¡å™¨æ—¶é—´ä¸ºå‡†

### 2. å¤šæ ‡ç­¾é¡µåŒæ­¥
- å½“å‰å®ç°ï¼šæ¯ä¸ªæ ‡ç­¾é¡µç‹¬ç«‹å€’è®¡æ—¶
- æ”¹è¿›æ–¹æ¡ˆï¼šä½¿ç”¨ BroadcastChannel API åŒæ­¥

### 3. ç¦»çº¿æ”¯æŒ
- å½“å‰å®ç°ï¼šéœ€è¦ç½‘ç»œè¿æ¥éªŒè¯è®¡æ—¶å™¨
- æ”¹è¿›æ–¹æ¡ˆï¼šä½¿ç”¨ Service Worker ç¼“å­˜

## ğŸ“ ä»£ç ä¿®æ”¹æ¸…å•

### åç«¯æ–‡ä»¶ (app.py)
- âœ… å¯¼å…¥ `timedelta`
- âœ… ä¿®æ”¹ `get_user_task_set()` æ·»åŠ  timer å­—æ®µ
- âœ… æ–°å¢ `check_task_timer()` å‡½æ•°
- âœ… æ–°å¢ `POST /api/users/me/tasks/{task_id}/start` API
- âœ… æ–°å¢ `GET /api/users/me/tasks/{task_id}/timer` API
- âœ… åœ¨ `get_ai_response()` æ·»åŠ è¶…æ—¶æ£€æŸ¥
- âœ… åœ¨ `get_ai_response_stream()` æ·»åŠ è¶…æ—¶æ£€æŸ¥

### å‰ç«¯æ–‡ä»¶ (index.html)
- âœ… ApiService æ·»åŠ  `startTaskTimer()` æ–¹æ³•
- âœ… ApiService æ·»åŠ  `getTaskTimer()` æ–¹æ³•
- âœ… ä¿®æ”¹ `startConversationTimer()` ä¸ºå¼‚æ­¥æŒä¹…åŒ–ç‰ˆæœ¬
- âœ… æ–°å¢ `lockConversation()` æ–¹æ³•
- âœ… æ–°å¢ `restoreTimerIfNeeded()` æ–¹æ³•
- âœ… ä¿®æ”¹ `loadChatHistory()` è°ƒç”¨æ¢å¤è®¡æ—¶å™¨

## âœ… éªŒæ”¶æ ‡å‡†

- [x] é¦–æ¬¡å¯åŠ¨ä»»åŠ¡æ—¶æ­£ç¡®åˆå§‹åŒ–è®¡æ—¶å™¨
- [x] åˆ·æ–°é¡µé¢åè®¡æ—¶å™¨ä»å‰©ä½™æ—¶é—´ç»§ç»­å€’è®¡æ—¶
- [x] å…³é—­æµè§ˆå™¨é‡æ–°æ‰“å¼€åè®¡æ—¶å™¨æ¢å¤
- [x] å€’è®¡æ—¶åˆ°0æ—¶è‡ªåŠ¨é”å®šè¾“å…¥æ¡†
- [x] åç«¯æ‹’ç»è¶…æ—¶åçš„æ¶ˆæ¯è¯·æ±‚
- [x] å¤šä¸ªä»»åŠ¡ç‹¬ç«‹è®¡æ—¶
- [x] åç«¯æ•°æ®æ­£ç¡®ä¿å­˜ timer å­—æ®µ
- [x] æ§åˆ¶å°æœ‰æ¸…æ™°çš„è°ƒè¯•æ—¥å¿—

## ğŸ‰ ä½¿ç”¨è¯´æ˜

1. **å¯åŠ¨æœåŠ¡å™¨**
```bash
python app.py
```

2. **ç™»å½•æµ‹è¯•è´¦å·**
   - è®¿é—® http://localhost:8000
   - ç™»å½• admin/psy2025

3. **å¼€å§‹ä»»åŠ¡**
   - ç‚¹å‡»"å¼€å§‹ä»»åŠ¡"
   - è§‚å¯Ÿè®¡æ—¶å™¨å€’è®¡æ—¶

4. **æµ‹è¯•åˆ·æ–°**
   - ç­‰å¾…å‡ åˆ†é’Ÿ
   - åˆ·æ–°é¡µé¢ (F5)
   - éªŒè¯è®¡æ—¶å™¨ä»å‰©ä½™æ—¶é—´ç»§ç»­

5. **æµ‹è¯•è¶…æ—¶**
   - ç­‰å¾…15åˆ†é’Ÿï¼ˆæˆ–ä¿®æ”¹ä¸º1åˆ†é’Ÿï¼‰
   - éªŒè¯è¾“å…¥æ¡†è¢«é”å®š

å®Œæˆï¼ğŸŠ
